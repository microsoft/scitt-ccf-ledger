# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

cmake_minimum_required(VERSION 3.16)

if((NOT CMAKE_CXX_COMPILER)
   AND "$ENV{CXX}" STREQUAL ""
)
  set(CMAKE_CXX_COMPILER "/opt/oe_lvi/clang++-10")
  message("Set CMAKE_CXX_COMPILER to /opt/oe_lvi/clang++-10")
endif()

project(scitt
  LANGUAGES C CXX
)

set(COMPILE_TARGET "sgx" CACHE STRING "Help")
option(ENABLE_DEBUG_MALLOC "Enable Open Enclave's debug malloc for enclave builds" OFF)
set(ATTESTED_FETCH_MRENCLAVE_HEX "" CACHE STRING "attested-fetch MRENCLAVE (hex)")
message(STATUS "ATTESTED_FETCH_MRENCLAVE_HEX=${ATTESTED_FETCH_MRENCLAVE_HEX}")
option(CCF_UNSAFE "Use CCF's unsafe variant (must be separately installed)" OFF)
option(BUILD_TESTS "Whether to build tests" ON)
option(ENABLE_PREFIX_TREE "Enable the prefix tree" OFF)

set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

if (CCF_UNSAFE)
  find_package(ccf_unsafe REQUIRED)
else()
  find_package(ccf_${COMPILE_TARGET} REQUIRED)
endif()

if (ENABLE_PREFIX_TREE)
  add_compile_definitions(ENABLE_PREFIX_TREE)
endif ()

set(CMAKE_GENERATED_COMMENT
    "This file was auto-generated by CMake from a corresponding *.in file. DO NOT EDIT"
)
configure_file(src/generated/constants.h.in src/generated/constants.h @ONLY)

add_ccf_app(scitt
  SRCS src/main.cpp
  INCLUDE_DIRS src ${CMAKE_CURRENT_BINARY_DIR}/src ${CCF_DIR}/include/ccf/_private
  INSTALL_LIBS ON
)

if (COMPILE_TARGET STREQUAL "sgx")
  # Generate an ephemeral signing key
  add_custom_command(
    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/signing_key.pem
    COMMAND openssl genrsa -out ${CMAKE_CURRENT_BINARY_DIR}/signing_key.pem -3 3072
  )
  add_custom_target(
    signing_key ALL DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/signing_key.pem
  )

  # Sign the application
  sign_app_library(scitt.enclave
    ${CMAKE_CURRENT_LIST_DIR}/oe_sign.conf
    ${CMAKE_CURRENT_BINARY_DIR}/signing_key.pem
    INSTALL_LIBS ON
  )
endif()

install(
  FILES
    constitution/actions.js
    constitution/apply.js
    constitution/resolve.js
    constitution/validate.js
    constitution/scitt.js
  DESTINATION share/scitt/constitution)

if (BUILD_TESTS)
  if (COMPILE_TARGET STREQUAL "sgx")
    message(SEND_ERROR "Unit tests are not supported on SGX builds. Use -DBUILD_TESTS=OFF to disable them.")
  endif()

  # Avoid Gtest files ending up in the scitt install directory   
  set(INSTALL_GTEST OFF)
  include(FetchContent)
  FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG release-1.12.1
  )
  FetchContent_MakeAvailable(googletest)

  set(RC_ENABLE_GTEST ON CACHE INTERNAL "")
  FetchContent_Declare(
    rapidcheck
    GIT_REPOSITORY https://github.com/emil-e/rapidcheck.git
    GIT_TAG 8fafda42e732164db58003e542196e94a28481f9
  )

  # We use an explicit GetProperties and Populate rather than the more concise MakeAvailable,
  # as this allows us to pass EXCLUDE_FROM_ALL to add_subdirectory. This stops RapidCheck
  # files from being installed with scitt.
  FetchContent_GetProperties(rapidcheck)
  if(NOT rapidcheck_POPULATED)
    FetchContent_Populate(rapidcheck)
    add_subdirectory(${rapidcheck_SOURCE_DIR} ${rapidcheck_BINARY_DIR} EXCLUDE_FROM_ALL)
  endif()

  # Because CCF libraries are built with libc++,
  # everything else has to be too.
  target_compile_options(gtest PUBLIC ${COMPILE_LIBCXX})
  target_compile_options(rapidcheck PUBLIC ${COMPILE_LIBCXX})
  add_san(gtest)
  add_san(rapidcheck)

  enable_testing()

  add_executable(
    unit_tests
    unit-tests/cbor_test.cpp
    unit-tests/verifier_test.cpp
    unit-tests/configurable_auth_test.cpp
    unit-tests/did/resolver_test.cpp
    unit-tests/did/web/syntax_test.cpp
    unit-tests/prefix_tree/bitvector_test.cpp
    unit-tests/prefix_tree/prefix_tree_test.cpp
    unit-tests/prefix_tree/batched_prefix_tree_test.cpp
  )
  add_san(unit_tests)
  target_compile_options(unit_tests PUBLIC ${COMPILE_LIBCXX})
  target_link_libraries(
    unit_tests PRIVATE
    GTest::gmock_main
    rapidcheck
    rapidcheck_gtest
    t_cose.host
    qcbor.host

    ccf_endpoints.host
    ccf_kv.host
    ccfcrypto.host
    http_parser.host
  )
  target_include_directories(
    unit_tests PRIVATE
    src
    unit-tests
    ${CCF_DIR}/include
    ${CCF_DIR}/include/3rdparty

    # openssl_wrappers depends on ds/x509_time_fmt.h
    ${CCF_DIR}/include/ccf/_private
  )

  include(GoogleTest)
  gtest_discover_tests(unit_tests)
endif()

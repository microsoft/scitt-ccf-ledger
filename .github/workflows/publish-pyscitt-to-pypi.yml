name: "Publish pyscitt package to PyPi"

on:
  release:
    types: [published]

jobs:
  build_and_publish:
    name: "Publish pyscitt package to PyPi"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Get release number from git tag (release) or latest (branch)
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        id: tref

      - name: Fetch PyPi Package from release
        run: |
          cd pyscitt
          RELEASE_WHEEL_URL=$(curl -s  https://api.github.com/repos/microsoft/scitt-ccf-ledger/releases/tags/${{steps.tref.outputs.version}} | jq -r '.assets[] | select(.name|test("pyscitt-.*.whl")) | .browser_download_url')
          echo ${RELEASE_WHEEL_URL}
          wget ${RELEASE_WHEEL_URL}

      - name: Publish PyPi Package to https://pypi.org/project/pyscitt/
        run: |
          set -ex
          cd pyscitt
          python3 -m venv env
          source ./env/bin/activate
          pip install twine
          twine upload -u __token__ -p ${{ secrets.PYPI_TOKEN }} *.whl

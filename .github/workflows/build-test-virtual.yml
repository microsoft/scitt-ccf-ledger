name: "Build/test (virtual)"
on: [push]
jobs:
  build-test:
    runs-on: ubuntu-20.04
    defaults:
      run:
        shell: bash
    container:
      image: mcr.microsoft.com/ccf/app/dev:3.0.9-virtual
      env:
        PLATFORM: virtual
    steps:
      - uses: actions/checkout@v3
      # Work-around for https://github.com/actions/runner/issues/2033
      - name: Work around git safe.directory in container
        run: chown -R $(id -u):$(id -g) $PWD
      - name: Install attested fetch dependency
        run: apt-get update && apt-get install -y libcurl4-openssl-dev
      - run: ./build.sh
      - run: ./run_unit_tests.sh
